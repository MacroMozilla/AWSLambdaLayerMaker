name: AWS Lambda Layer Build

on:
  workflow_dispatch:
  
jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
  
    steps:
      - name: Delete ALL workflow runs in this repository
        uses: Mattraks/delete-workflow-runs@v2
        with:
          # Your PAT with actions:write permission
          token: ${{ secrets.DELETE_ACTION_RUN_TOKEN }}
          repository: ${{ github.repository }}
  
          # Remove all runs without keeping any history
          retain_days: 0                # Default is 30 days; must be 0 to delete ALL runs
          keep_minimum_runs: 0          # Do not keep any runs
  
          # Delete only this workflow‚Äôs runs (you can also leave empty to delete all workflows)
          delete_workflow_pattern: ""
  
          # Include workflows regardless of their state (active/disabled/archived)
          delete_workflow_by_state_pattern: "ALL"
  
          # Delete runs of all conclusion types
          delete_run_by_conclusion_pattern: "SUCCESS,FAILURE,CANCELLED,TIMED_OUT,NEUTRAL,SKIPPED,STALE,ACTION_REQUIRED"
  
          # Disable dry-run mode to actually perform deletion
          dry_run: false
  
  build:
    runs-on: ubuntu-latest
    needs: [cleanup]
    steps:
      # 1Ô∏è‚É£ ÊãâÂèñ‰ª£Á†Å
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ ËÆæÁΩÆ Python ÁéØÂ¢É
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3Ô∏è‚É£ ÂÆâË£Ö‰æùËµñÂà∞ python/ Êñá‰ª∂Â§π
      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies into python/..."
          python -m pip install --upgrade pip
          mkdir -p python
          pip install --no-cache-dir -r requirements.txt -t python/
          echo "‚úÖ Dependencies installed into ./python/"
      
      # 4Ô∏è‚É£ ÊâßË°å cmd.txt ‰∏≠ÁöÑÂëΩ‰ª§ÔºàÈÄêË°åÊâßË°åÔºå‰ΩúÁî®ËåÉÂõ¥Âú® python/Ôºâ
      - name: Run custom commands from cmd.txt
        run: |
          echo "‚öôÔ∏è Running commands from cmd.txt inside python/ ..."
          pushd python > /dev/null
          while IFS= read -r line || [ -n "$line" ]; do
            echo "‚û°Ô∏è Executing: $line"
            bash -c "$line"
          done < ../cmd.txt
          popd > /dev/null
          echo "‚úÖ Finished running commands from cmd.txt"
          
      # 6Ô∏è‚É£ ‰∏ä‰º† artifactÔºà‰ªÖ‰∏ÄÂ±Ç ZIPÔºâ
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: aws_package
          path: ./
